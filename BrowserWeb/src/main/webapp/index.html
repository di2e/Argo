<!-- 
 * Copyright 2015 Jeff Simpson.
 *
 * Licensed under the MIT License, (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://opensource.org/licenses/MIT
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 -->
 
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DI2E RTSD Browser</title>

  <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1/jquery-ui.min.js" type="text/javascript"></script>
  
  <link href='http://fonts.googleapis.com/css?family=Josefin+Sans:600|Varela|Hammersmith+One|Indie+Flower|Karla|Orbitron' rel='stylesheet' type='text/css'>
 
  <link href="js/jquery.fancytree/skin-win8/ui.fancytree.css" rel="stylesheet" type="text/css">
  <script src="js/jquery.fancytree/jquery.fancytree.js" type="text/javascript"></script>
  <style>
  	ul.fancytree-container { font-size: 12pt }
  	span.fancytree-title { font-family: 'Karla', sans-serif; font-size: 14pt; }
  	div.service-details { font-family: 'Karla', serif; font-size: 15pt; }
  	td.detail-key { font-family: 'Karla', sans-serif; background-color: rgb(199, 213, 213); padding: 3px 25px; font-weight: bold }
  	td.detail-data { font-family: 'Karla', sans-serif; font-size: 14pt; padding: 0 }
  	a.detail-data { font-family: 'Karla', sans-serif; font-size: 14pt; padding: 0 }
  	.ui-button-text { font-family: 'Karla', sans-serif; }
    .ui-tabs { font-family: 'Karla', sans-serif; }
  </style>

<script type="text/javascript">

	var services;
	var byContract;
	var serviceList;

  $(function(){
    initTree();

    $("#refreshButton").button().click(function(event) { refresh(); });
    $("#probeButton").button().click(function(event) { launchProbe(); refresh(); });
    $( "#tabs" ).tabs();
    $("#clearButton").button().click(function(event) { clearCache(); refresh(); });

    getIPAddressInformation();
    getServices();
    
  });


  function getIPAddressInformation() {
	  $.ajax({
          url: "/BrowserWeb/api/controller/ipAddrInfo",
          data: { },
          async: false,
          success: function( data ) {
        	  $("#ipAddrInfo").html(data);
          },
          error: function ( data ) { alert("failed"); }
        });


	  }

  function launchProbe() {
	  $.ajax({
		  url: "/BrowserWeb/api/controller/launchProbe",
		  data: { },
		  async: false,
		  success: function( data ) {
			  alert("Response: " + data);
		  },
		  error: function ( data ) { alert("failed"); }
		});


	  }

  function refresh() {

	  getServices();
	  }

  function getContracts() {
	  $.ajax({
		  url: "/AsynchListener/api/responseHandler/contracts",
		  data: { },
		  success: function( data ) {
			  alert("got contracts: " + data);
			  var newSource = [];

			  for (var contract in data.contracts) {
				newSource.push({"title": contract.contractDescription, "key" : contract.contractID});

				  };

			  byContract.source(newSource);
		  }
		});


	  };

  function clearCache() {
	  $.ajax({
		  url: "/AsynchListener/api/responseHandler/clearCache",
		  data: { },
		  success: function( data ) {
			 refresh();
		  },
		  fail: function(data) {
			  alert(data);
		  }
		});


	  };
		  
  function getServices() {
	  $.ajax({
		  url: "/BrowserWeb/api/controller/responses",
		  data: { },
		  success: function( data ) {
			  //alert("got services");
			  
			  $("#serviceTable1").html("");
			  
			  var i;
			  var newSource = [];

			  var contractIDMap = {};
			  for(i = 0; i < data.cache.length; i++) {
				  var service = data.cache[i];
				  var contract = contractIDMap[service.serviceContractID];
				  if (!contract) {
					  contract = { "contractID" : service.serviceContractID,
							  "contractDescription" : service.contractDescription, "services" : []};
					  contractIDMap[service.serviceContractID] = contract;
					  }
				  contract.services.push(service);
			  }

			  var s;
			  for (key in contractIDMap) {
				  contract = contractIDMap[key];
				  var contractSource = { "title" : contract.contractDescription, "key" : contract.contractID, "folder" : true, "children" : []};
				  for (s = 0; s < contract.services.length; s++) {
					  var service = contract.services[s];
					  contractSource.children.push({"title": service.serviceName + " : " + service.consumability, "key" : service.id, "data" : service});
					  
					  };
				  newSource.push(contractSource);

				  }

			  $("#byContract").fancytree("option", "source",  newSource );

			  var node = $("#byContract").fancytree("getRootNode");
			  node.sortChildren(null, true);			  

			  newSource = [];
			  

			  for(i = 0; i < data.cache.length; i++) {
				  var service = data.cache[i];
 				  newSource.push({"title": service.serviceName + " : " + service.consumability, "key" : service.id, "data" : service});
				  };

			  $("#serviceList").fancytree("option", "source",  newSource );

			  node = $("#serviceList").fancytree("getRootNode");
			  node.sortChildren(null, true);
			  
		    }
			 
      
		});



	  };

  function renderServiceInTable(service, table) {
	  
	  	var row = $("<tr />");
	  	table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
	    row.append($("<td align='right' class='detail-key'>Service ID</td>"));
	    row.append($("<td class='detail-data'>" + service.id + "</td>"));

	  	var row = $("<tr />");
	  	table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
	    row.append($("<td align='right' class='detail-key'>Service Name</td>"));
	    row.append($("<td class='detail-data'>" + service.serviceName + "</td>"));

	  	var row = $("<tr />");
	  	table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
	    row.append($("<td align='right' class='detail-key'>Service Description</td>"));
	    row.append($("<td class='detail-data'>" + service.description + "</td>"));

	  	var row = $("<tr />");
	  	table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
	    row.append($("<td align='right' class='detail-key'>Contract ID</td>"));
	    row.append($("<td class='detail-data'>" + service.serviceContractID + "</td>"));

	  	var row = $("<tr />");
	  	table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
	    row.append($("<td align='right' class='detail-key'>Contract Description</td>"));
	    row.append($("<td class='detail-data'>" + service.contractDescription + "</td>"));

	  	var row = $("<tr />");
	  	table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
	    row.append($("<td align='right' class='detail-key'>Consumability</td>"));
	    row.append($("<td class='detail-data'>" + service.consumability + "</td>"));

	  	var row = $("<tr />");
	  	table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
	    row.append($("<td align='right' class='detail-key'>TTL</td>"));
	    row.append($("<td class='detail-data'>" + service.ttl + "</td>"));

	    var arrayLength = service.accessPoints.length;
	    for (var i = 0; i < arrayLength; i++) {
		    var accessPoint = service.accessPoints[i];

	        table.append("<tr><td class='access-point-header'>Access Point: " + accessPoint.label + " </td></tr>");

		  	var row = $("<tr />");
		  	table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
		    row.append($("<td align='right' class='detail-key'>AP IP Address</td>"));
		    row.append($("<td class='detail-data access-point'>" + accessPoint.ipAddress + "</td>"));

		    var row = $("<tr />");
		  	table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
		    row.append($("<td align='right' class='detail-key'>AP Port</td>"));
		    row.append($("<td class='detail-data access-point'>" + accessPoint.port + "</td>"));

		  	var row = $("<tr />");
		  	table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
		    row.append($("<td align='right' class='detail-key'>AP URL</td>"));
			if (service.consumability == "HUMAN_CONSUMABLE") {
				row.append($("<td class='detail-data access-point'><a href='" + accessPoint.url + "'>" + accessPoint.url + "</td>"));
			} else {
				row.append($("<td class='detail-data access-point'>" + accessPoint.url + "</td>"));
			}
			
		    var row = $("<tr />");
            table.append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
            row.append($("<td align='right' class='detail-key'>AP Data</td>"));
            var apData = window.atob(accessPoint.data);
            if (accessPoint.dataType == "image") {
            	var img = $('<td class="detail-data access-point"><img alt="star" src="'+apData+'" /></td>');
                row.append(img);
            } else { //assume text
                row.append($("<td class='detail-data access-point'>" + apData + "</td>"));
            }
 
			    
	    }
	    
	    
	  }
	  

  function initTree() {
	$("#byContract").fancytree({
	      checkbox: false,
	      selectMode: 2,
	      source: [],
	      activate: function(event, data) {
		      if (data.node.data.serviceName) {
		         //alert("selected " + data.node.data.serviceName);
		         $("#serviceTable1").html("");
		         renderServiceInTable(data.node.data, $("#serviceTable1"));
		      } else {
		    	  $("#serviceTable1").html("");
			      }
	        }
	    });
	 $("#serviceList").fancytree({
	      checkbox: false,
	      selectMode: 3,
	      source: [],
	      activate: function(event, data) {
		      if (data.node.data.serviceName) {
		         //alert("selected " + data.node.data.serviceName);
		         $("#serviceTable2").html("");
		         renderServiceInTable(data.node.data, $("#serviceTable2"));
		      } else {
		    	  $("#serviceTable2").html("");
			      }
	        }
	      
	    });
		 var node = $("#byContract").fancytree("getRootNode");
	     node.sortChildren(null, true);
		 node = $("#serviceList").fancytree("getRootNode");
	     node.sortChildren(null, true);
		  
	  };
</script>

 </head>
<body>



	<div class="intro">
		<div id="header">
			<table style="width: 100%">
			 <tr><td><a href="http://devtools.di2e.net" target="_blank"><img alt="" src="images/framework.png"/></a></td><td align="left"><p style="font-family: 'Karla', sans-serif; font-weight 300; font-size: 25pt">Runtime Service Discovery Browser</p></td></tr>
			</table>
			
			
		</div>
		
		<!-- The name attribute is used by tree.serializeArray()  -->
		</div>
		<div>
			<button id="refreshButton">Refresh List</button>
			<button id="probeButton">Launch Probe</button>
			<button id="clearButton">Clear Cache</button>
		</div>
		<div id="tabs">
			<ul>
				<li><a href="#tabs-1">Services by Contract</a></li>
				<li><a href="#tabs-2">Plain Service List</a></li>
			</ul>
			<div id="tabs-1">
				<div id="byContract" name="selNodes"></div>
				<fieldset style="margin-top: 20px;">
					<legend>Service Details</legend>
					<div class="service-details" id="serviceDetails1">
						<table id="serviceTable1"></table>
					</div>
				</fieldset>
			</div>
			<div id="tabs-2">
				<div id="serviceList" name="selNodes2"></div>
				<fieldset style="margin-top: 20px;">
					<legend>Service Details</legend>
					<div class="serviceDetails" id="serviceDetails2" style='background-color: white'>
						<table id="serviceTable2"></table>
					</div>
				</fieldset>
			</div>
		</div>

        <div id="ipAddrInfo" style="font-family: 'Karla', sans-serif; font-weight 200; font-size: 12pt">
 	</div>
       




</body>
</html>
